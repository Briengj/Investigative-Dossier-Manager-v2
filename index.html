<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigation Dossier Manager v2 - Loading Bugfix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            Timestamp,
            serverTimestamp,
            arrayUnion, 
            arrayRemove 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Application Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyDKhrmjIksOT33GXnHr9hUFhBytWuhX83c",
  authDomain: "invdosmgr-backend-v2.firebaseapp.com",
  projectId: "invdosmgr-backend-v2",
  storageBucket: "invdosmgr-backend-v2.firebasestorage.app",
  messagingSenderId: "974909853701",
  appId: "1:974909853701:web:6f3d5f7a2bef40ff558c6c"
}; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dossier-app-v2-loading-bugfix';

        // --- Firebase Globals ---
        let app, auth, db, currentUserId = null, dossiersCollectionRef;
        let dossiersListener = null; 

        // --- UI Element References ---
        // ... (all UI element const declarations remain the same as 'Final Polished')
        const loadingIndicator = document.getElementById('loadingIndicator');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageDisplayDiv = document.getElementById('messageDisplayDiv');
        const noDossierSelectedMessage = document.getElementById('noDossierSelectedMessage');
        const selectedDossierDiv = document.getElementById('selectedDossier');
        const createDossierForm = document.getElementById('createDossierForm');
        const subjectNameInput = document.getElementById('subjectName');
        const caseIdInput = document.getElementById('caseId');
        const statusInput = document.getElementById('status');
        const summaryInput = document.getElementById('summary');
        const dossiersListDiv = document.getElementById('dossiersList');
        const dossierDetailsDiv = document.getElementById('dossierDetails');
        const deleteDossierBtn = document.getElementById('deleteDossierBtn');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const addProfileItemForm = document.getElementById('addProfileItemForm');
        const profileItemTypeInput = document.getElementById('profileItemType');
        const profileItemLabelInput = document.getElementById('profileItemLabel');
        const profileItemValueInput = document.getElementById('profileItemValue');
        const profileItemNotesInput = document.getElementById('profileItemNotes');
        const subjectProfileListDiv = document.getElementById('subjectProfileList');
        const addSearchLogForm = document.getElementById('addSearchLogForm');
        const searchQueryTextInput = document.getElementById('searchQueryText');
        const searchPlatformInput = document.getElementById('searchPlatform');
        const searchLogNotesInput = document.getElementById('searchLogNotes');
        const searchLogListDiv = document.getElementById('searchLogList');
        const addEnvDetailForm = document.getElementById('addEnvDetailForm');
        const envDetailTypeInput = document.getElementById('envDetailType');
        const envDetailValueInput = document.getElementById('envDetailValue');
        const envDetailNotesInput = document.getElementById('envDetailNotes');
        const envDetailsListDiv = document.getElementById('envDetailsList');
        const notesListDiv = document.getElementById('notesList');
        const addNoteForm = document.getElementById('addNoteForm');
        const noteContentInput = document.getElementById('noteContent');
        const linkableArtifactsContainer = document.getElementById('linkableArtifactsContainer'); 
        const artifactsListDiv = document.getElementById('artifactsList');
        const addArtifactForm = document.getElementById('addArtifactForm');
        const artifactNameInput = document.getElementById('artifactName');
        const artifactTypeInput = document.getElementById('artifactType');
        const artifactSourceInput = document.getElementById('artifactSource');
        const artifactCategoryInput = document.getElementById('artifactCategory');
        const artifactDescriptionInput = document.getElementById('artifactDescription');
        const artifactMetadataStrippedInput = document.getElementById('artifactMetadataStripped');
        const importFileInput = document.getElementById('importFileInput');
        const importArtifactTypeInput = document.getElementById('importArtifactTypeInput');
        const importCategoryInput = document.getElementById('importCategoryInput');
        const processImportBtn = document.getElementById('processImportBtn');
        const bulkUrlInput = document.getElementById('bulkUrlInput');
        const bulkUrlCategoryInput = document.getElementById('bulkUrlCategoryInput');
        const bulkUrlDescriptionInput = document.getElementById('bulkUrlDescriptionInput');
        const addBulkUrlsBtn = document.getElementById('addBulkUrlsBtn');
        const editNoteLinksModal = document.getElementById('editNoteLinksModal');
        const editNoteModalContent = document.getElementById('editNoteModalContent');
        const editNoteModalArtifactsContainer = document.getElementById('editNoteModalArtifactsContainer');
        const saveNoteLinksBtn = document.getElementById('saveNoteLinksBtn');
        const cancelEditNoteLinksBtn = document.getElementById('cancelEditNoteLinksBtn');
        let currentEditingNoteId = null; 
        const confirmModal = document.getElementById('confirmModal');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const modalMessage = document.getElementById('modalMessage');
        const modalTitle = document.getElementById('modalTitle');
        let confirmActionCallback = null; 
        let selectedDossierId = null;    
        let currentDossiers = [];       

        // --- Global Error Handlers ---
        window.addEventListener('error', function(event) { /* ... same ... */ });
        window.addEventListener('unhandledrejection', function(event) { /* ... same ... */ });

        // --- Utility Functions ---
        function showLoading(isLoading) { if(loadingIndicator) loadingIndicator.classList.toggle('hidden', !isLoading); }
        function displayUserMessage(message, isError = true) { /* ... same ... */ }
        function generateCaseId() { /* ... same ... */ }
        function generateUUID() { /* ... same ... */ } 
        function escapeHTML(str) { /* ... same ... */ }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebaseServices() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.apiKey === "") {
                    displayUserMessage("CRITICAL: Firebase configuration is missing or uses placeholder values. Please update index.html.", true);
                    console.error("[DEBUG] Firebase config error: API Key is placeholder or missing. Update required in index.html.");
                    showLoading(false);
                    return;
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                showLoading(true); 
                if(userIdDisplay) userIdDisplay.textContent = "User ID: Initializing...";
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if(userIdDisplay) userIdDisplay.textContent = `User ID: ${currentUserId}`;
                        dossiersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/dossiers`);
                        console.log("[DEBUG] Auth state changed: User authenticated. Loading dossiers for user:", currentUserId);
                        loadDossiers(); 
                    } else {
                        console.log("[DEBUG] Auth state changed: User is signed out or auth state not yet determined.");
                        currentUserId = null;
                        if (dossiersListener) { dossiersListener(); dossiersListener = null; }
                        currentDossiers = []; renderDossiersList(currentDossiers); 
                        resetSelectedDossierView(); 
                        if(userIdDisplay) userIdDisplay.textContent = "User ID: Authenticating...";
                        showLoading(false); // Ensure loading stops if user is not authenticated after check
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("[DEBUG] Attempting custom token sign-in...");
                    await signInWithCustomToken(auth, __initial_auth_token)
                       .then(() => console.log("[DEBUG] Custom token sign-in successful or user already signed in."))
                       .catch(e => { displayUserMessage(`Custom token sign-in failed: ${e.message}`, true); if(userIdDisplay) userIdDisplay.textContent = "User ID: Auth Failed"; showLoading(false); });
                } else {
                    console.log("[DEBUG] No custom token found, attempting anonymous sign-in...");
                    await signInAnonymously(auth)
                       .then(() => console.log("[DEBUG] Anonymous sign-in successful or user already signed in."))
                       .catch(e => { displayUserMessage(`Anonymous sign-in failed: ${e.message}`, true); if(userIdDisplay) userIdDisplay.textContent = "User ID: Auth Failed"; showLoading(false); });
                }
            } catch (error) { 
                displayUserMessage("Firebase core initialization failed: " + error.message, true); 
                console.error("[DEBUG] Firebase core initialization error:", error);
                if(userIdDisplay) userIdDisplay.textContent = "User ID: Init Failed"; 
                showLoading(false); 
            }
        }

        // --- Dossier Management Functions ---
        async function handleCreateDossier(event) {
            event.preventDefault();
            if (!currentUserId) return displayUserMessage("User not authenticated. Cannot create dossier.");
            showLoading(true);
            const subjectName = subjectNameInput.value.trim();
            let caseId = caseIdInput.value.trim() || generateCaseId();
            if (!subjectName) { displayUserMessage("Subject Name is required."); showLoading(false); return; }
            console.log(`[DEBUG] handleCreateDossier: Attempting to create dossier for subject: ${subjectName}`);
            try {
                const newDossierData = {
                    subjectName, caseId, status: statusInput.value, summary: summaryInput.value.trim(),
                    createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
                    subjectProfile: [], searchLogs: [], environmentDetails: [], notes: [], artifacts: [] 
                };
                const docRef = await addDoc(dossiersCollectionRef, newDossierData);
                console.log("[DEBUG] handleCreateDossier: Dossier created successfully with ID:", docRef.id);
                if(createDossierForm) createDossierForm.reset(); 
                if(caseIdInput) caseIdInput.value = '';
                displayUserMessage(`Dossier for "${escapeHTML(subjectName)}" created successfully.`, false);
                // The onSnapshot listener in loadDossiers should automatically update the list.
            } catch (e) { 
                console.error("[DEBUG] handleCreateDossier: Error creating dossier:", e);
                displayUserMessage("Failed to create dossier: " + e.message, true); 
            } finally { 
                showLoading(false); 
            }
        }

        function loadDossiers() {
            if (!currentUserId || !dossiersCollectionRef) { 
                console.warn("[DEBUG] loadDossiers: Aborted. UserID:", currentUserId, "CollectionRef:", dossiersCollectionRef); 
                if(dossiersListDiv) dossiersListDiv.innerHTML = '<p class="text-gray-500 italic p-4">Authentication required to load dossiers.</p>';
                showLoading(false); return; 
            }
            showLoading(true); // Ensure loading is active before starting snapshot
            if (dossiersListener) {
                console.log("[DEBUG] loadDossiers: Unsubscribing from previous dossiers listener.");
                dossiersListener(); 
                dossiersListener = null;
            }
            
            console.log("[DEBUG] loadDossiers: Setting up new dossiers listener for user:", currentUserId);
            dossiersListener = onSnapshot(dossiersCollectionRef, 
                (querySnapshot) => {
                    console.log("[DEBUG] onSnapshot: SUCCESS - Received update. Docs count:", querySnapshot.size);
                    try {
                        const previousSelectedDossierId = selectedDossierId; 
                        currentDossiers = [];
                        querySnapshot.forEach((doc) => {
                            currentDossiers.push({ id: doc.id, ...doc.data() });
                        });
                        // console.log("[DEBUG] onSnapshot: currentDossiers populated:", currentDossiers.length, "items.");
                        renderDossiersList(currentDossiers); 
                        
                        if (previousSelectedDossierId) { 
                            const updatedSelectedDossier = currentDossiers.find(d => d.id === previousSelectedDossierId);
                            if (updatedSelectedDossier) { 
                                console.log("[DEBUG] onSnapshot: Re-rendering selected dossier:", previousSelectedDossierId);
                                renderSelectedDossier(updatedSelectedDossier); 
                            } else { 
                                console.warn(`[DEBUG] onSnapshot WARN: Previously selected dossier ID ${previousSelectedDossierId} no longer found. Resetting view.`);
                                resetSelectedDossierView(); 
                            }
                        }
                    } catch (renderError) {
                        console.error("[DEBUG] onSnapshot: Error during data processing or rendering inside snapshot callback:", renderError);
                        displayUserMessage("Error updating dossier display: " + renderError.message, true);
                    } finally {
                        showLoading(false); // CRITICAL: Ensure loading is stopped after processing snapshot
                        console.log("[DEBUG] onSnapshot: Processing complete, loading indicator hidden.");
                    }
                }, 
                (error) => { 
                    console.error("[DEBUG] onSnapshot: ERROR - Firestore listener error:", error);
                    displayUserMessage("Error fetching dossiers: " + error.message + ". Check console.", true); 
                    if(dossiersListDiv) dossiersListDiv.innerHTML = '<p class="text-red-600 p-4">Error fetching dossiers. Please try refreshing.</p>';
                    showLoading(false); // CRITICAL: Ensure loading is stopped on listener error
                }
            );
        }
        
        function resetSelectedDossierView() { /* ... (Same as previous 'Final Polished' version, with console.log) ... */ }
        function renderDossiersList(dossiers) { /* ... (Same as previous 'Final Polished' version) ... */ }
        function selectDossier(dossierId) { /* ... (Same as previous 'Final Polished' version, with console.log) ... */ }
        function renderSelectedDossier(dossier) { /* ... (Same as previous 'Final Polished' version) ... */ }
        function renderDossierDetails(dossier) { /* ... (Same as previous 'Final Polished' version) ... */ }
        function getStatusColor(status) { /* ... (Same as previous 'Final Polished' version) ... */ }
        
        // --- Subject Profile Functions ---
        async function handleAddProfileItem(event) { /* ... (Same, ensure robust error handling) ... */ }
        async function handleDeleteProfileItem(profileItemId) { /* ... (Same, ensure robust error handling) ... */ }
        function renderSubjectProfile(profileItems) { /* ... (Same, ensure robust rendering) ... */ }
        
        // --- Search Log Functions ---
        async function handleAddSearchLog(event) { /* ... (Same, ensure robust error handling) ... */ }
        async function handleDeleteSearchLog(logId) { /* ... (Same, ensure robust error handling) ... */ }
        function renderSearchLogs(searchLogs) { /* ... (Same, ensure robust rendering) ... */ }

        // --- Environment Detail Functions ---
        async function handleAddEnvDetail(event) { /* ... (Same, ensure robust error handling) ... */ }
        async function handleDeleteEnvDetail(detailId) { /* ... (Same, ensure robust error handling) ... */ }
        function renderEnvironmentDetails(envDetails) { /* ... (Same, ensure robust rendering) ... */ }

        // --- Notes Section Functions ---
        function updateLinkableArtifactsCheckboxes(artifacts, containerElement = linkableArtifactsContainer, existingLinks = []) { /* ... (Same) ... */ }
        async function handleAddNote(event) {
            event.preventDefault();
            if (!selectedDossierId || !currentUserId) {
                displayUserMessage("Select a dossier first to add a note."); return;
            }
            if (!addNoteForm || !noteContentInput || !linkableArtifactsContainer) {
                displayUserMessage("Note form elements not found. UI might be corrupted.", true); 
                console.error("[DEBUG] handleAddNote: Missing form elements."); return;
            }
            showLoading(true);
            const content = noteContentInput.value.trim();
            if (!content) { 
                displayUserMessage("Note content cannot be empty."); 
                showLoading(false); return; 
            }

            const linkedArtifactIds = Array.from(linkableArtifactsContainer.querySelectorAll('.artifact-link-checkbox:checked')).map(cb => cb.value);
            const newNote = { 
                noteId: generateUUID(), 
                content: content,
                timestamp: Timestamp.now(),
                linkedArtifactIds: linkedArtifactIds 
            }; 
            console.log("[DEBUG] handleAddNote: Attempting to add note:", JSON.stringify(newNote), "to dossier ID:", selectedDossierId);

            try {
                const dossierDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                await updateDoc(dossierDocRef, { 
                    notes: arrayUnion(newNote), 
                    updatedAt: serverTimestamp() 
                });
                console.log("[DEBUG] handleAddNote: Firestore updateDoc for addNote successful for dossier:", selectedDossierId);
                
                if(addNoteForm) addNoteForm.reset(); 
                if(linkableArtifactsContainer) linkableArtifactsContainer.querySelectorAll('.artifact-link-checkbox:checked').forEach(cb => cb.checked = false);
                
                displayUserMessage("Note added successfully.", false);
                // The onSnapshot listener in loadDossiers will handle re-rendering.
            } catch (error) { 
                console.error("[DEBUG] handleAddNote: Detailed error adding note to Firestore:", error); 
                displayUserMessage("Failed to add note: " + error.message + ". Please check the console for details.", true);
            } finally { 
                showLoading(false); 
            }
        }
        function openEditNoteLinksModal(noteId) { /* ... (Same) ... */ }
        async function handleSaveNoteLinks() { /* ... (Same, ensure robust error handling) ... */ }
        function renderNotesList(notes, allDossierArtifacts = []) { /* ... (Same, ensure robust rendering) ... */ }

        // --- Artifacts Section Functions ---
        async function handleAddArtifact(event) { /* ... (Same, ensure robust error handling) ... */ }
        async function handleDeleteArtifact(artifactIdToDelete) { /* ... (Same, ensure robust error handling) ... */ }
        function renderArtifactsList(artifacts) { /* ... (Same, ensure robust rendering) ... */ }
        
        // --- File Import Function ---
        async function handleProcessImportedFile() { /* ... (Same, ensure robust error handling) ... */ }

        // --- Bulk URL Import Function ---
        async function handleAddBulkUrls() { /* ... (Same, ensure robust error handling) ... */ }

        // --- Dossier Deletion Function ---
        async function handleDeleteDossier() { /* ... (Same, ensure robust error handling) ... */ }

        // --- Reporting Function ---
        function handleGenerateReport() { /* ... (Same, ensure robust error handling) ... */ }

        // --- Event Listeners Setup ---
        function safelyAddEventListener(element, event, handler) { /* ... (Same) ... */ }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseServices(); 
            // All other event listeners from 'Final Polished' version are set up here via safelyAddEventListener
            // ... (ensure all listeners are present as in the previous final version)
            safelyAddEventListener(createDossierForm, 'submit', handleCreateDossier);
            safelyAddEventListener(deleteDossierBtn, 'click', handleDeleteDossier); 
            safelyAddEventListener(generateReportBtn, 'click', handleGenerateReport);
            safelyAddEventListener(addProfileItemForm, 'submit', handleAddProfileItem);
            safelyAddEventListener(profileItemTypeInput, 'change', () => { 
                if(profileItemLabelInput && profileItemTypeInput){
                    const showLabel = ['Custom Field', 'Social Media Profile', 'Other'].includes(profileItemTypeInput.value); 
                    profileItemLabelInput.classList.toggle('hidden', !showLabel); 
                    if (!showLabel) profileItemLabelInput.value = ''; 
                }
            });
            safelyAddEventListener(addSearchLogForm, 'submit', handleAddSearchLog);
            safelyAddEventListener(addEnvDetailForm, 'submit', handleAddEnvDetail);
            safelyAddEventListener(addNoteForm, 'submit', handleAddNote);
            safelyAddEventListener(saveNoteLinksBtn, 'click', handleSaveNoteLinks);
            safelyAddEventListener(cancelEditNoteLinksBtn, 'click', () => { if(editNoteLinksModal) editNoteLinksModal.classList.add('hidden'); currentEditingNoteId = null; });
            safelyAddEventListener(addArtifactForm, 'submit', handleAddArtifact);
            safelyAddEventListener(processImportBtn, 'click', handleProcessImportedFile);
            safelyAddEventListener(addBulkUrlsBtn, 'click', handleAddBulkUrls);
            
            safelyAddEventListener(confirmYesBtn, 'click', () => { 
                if (typeof confirmActionCallback === 'function') { 
                    try { confirmActionCallback(); } 
                    catch(e) { displayUserMessage("Error executing confirmed action: " + e.message, true); console.error("Error in confirmActionCallback:", e); }
                } 
                if(confirmModal) confirmModal.classList.add('hidden'); 
                confirmActionCallback = null; 
            });
            safelyAddEventListener(confirmNoBtn, 'click', () => { 
                if(confirmModal) confirmModal.classList.add('hidden'); 
                confirmActionCallback = null; 
            });
        });
    </script>
    <style> /* ... (Styles remain the same as 'Final Polished' version) ... */ </style>
</head>
<body class="bg-slate-200 text-gray-800">
    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-[70] hidden"> <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div> </div>
    <div id="messageDisplayDiv" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl hidden z-[80] transition-all duration-500 ease-in-out max-w-md text-sm font-medium"></div>
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] hidden p-4"> <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full"> <h3 class="text-lg font-semibold mb-4 text-gray-800" id="modalTitle">Confirm Action</h3> <p class="mb-6 text-gray-700 text-sm" id="modalMessage">Are you sure?</p> <div class="flex justify-end space-x-3"> <button id="confirmNoBtn" class="button-secondary text-sm">No</button> <button id="confirmYesBtn" class="button-danger text-sm">Yes</button> </div> </div> </div>
    <div id="editNoteLinksModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] hidden p-4"> <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full"> <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Edit Links for Note</h3> <p id="editNoteModalContent" class="text-sm text-gray-700 mb-4 p-3 bg-slate-50 border border-slate-200 rounded max-h-24 overflow-y-auto whitespace-pre-wrap"></p> <div id="editNoteModalArtifactsContainer" class="space-y-1 max-h-48 overflow-y-auto border border-gray-200 p-3 rounded-md bg-white mb-4"><p class="text-xs text-gray-500 italic">Loading artifacts to link...</p></div> <div class="flex justify-end space-x-3 mt-5"> <button id="cancelEditNoteLinksBtn" class="button-secondary text-sm">Cancel</button> <button id="saveNoteLinksBtn" class="button-primary text-sm">Save Link Changes</button> </div> </div> </div>
    <header class="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-40 h-16 flex items-center justify-center"> <div> <h1 class="text-2xl md:text-3xl font-bold text-center tracking-tight">Investigation Dossier Manager</h1> <p id="userIdDisplay" class="text-xs text-center text-slate-300 mt-0.5">User ID: Loading...</p> </div> </header>
    <div class="flex flex-col md:flex-row max-w-full mx-auto p-3 md:p-4 gap-4 main-layout-height">
        <div class="w-full md:w-1/3 lg:w-1/4 bg-slate-50 p-4 rounded-xl shadow-lg sidebar flex flex-col">
            <section id="createSection" class="mb-6"> <h2 class="text-xl font-semibold mb-3 text-slate-700 border-b border-slate-300 pb-2">Create New Dossier</h2> <form id="createDossierForm" class="space-y-4"> <div><label for="subjectName" class="block text-sm font-medium text-gray-700">Subject Name*</label><input type="text" id="subjectName" name="subjectName" required class="input-field"></div> <div><label for="caseId" class="block text-sm font-medium text-gray-700">Case ID (optional)</label><input type="text" id="caseId" name="caseId" class="input-field"></div> <div><label for="status" class="block text-sm font-medium text-gray-700">Status</label><select id="status" name="status" class="input-field bg-white"><option>Open</option><option>In Progress</option><option>Pending</option><option>Closed</option></select></div> <div><label for="summary" class="block text-sm font-medium text-gray-700">Summary</label><textarea id="summary" name="summary" rows="3" class="input-field"></textarea></div> <button type="submit" class="button-primary w-full">Create Dossier</button> </form> </section>
            <section id="listSection" class="flex-grow flex flex-col min-h-0"><h2 class="text-xl font-semibold mb-3 text-slate-700 border-b border-slate-300 pb-2">Existing Dossiers</h2><div id="dossiersList" class="mt-2 space-y-2 flex-grow overflow-y-auto pr-1"><p class="text-gray-500 italic p-4 text-center">Loading dossiers...</p></div></section>
        </div>
        <div class="w-full md:w-2/3 lg:w-3/4 bg-slate-50 p-4 rounded-xl shadow-lg main-content-scroll-area flex flex-col">
            <div id="noDossierSelectedMessage" class="text-center text-gray-500 py-10 flex-grow flex flex-col items-center justify-center"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-20 h-20 mx-auto text-gray-400 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg> <p class="text-xl text-gray-600">Select a dossier from the list to view its details, or create a new one.</p> </div>
            <div id="selectedDossier" class="hidden flex-grow flex flex-col min-h-0">
                <section id="dossierDetailsSection" class="mb-6 pb-4 border-b border-slate-300"> <div id="dossierDetails"></div> <div class="mt-4 flex flex-wrap gap-2"> <button id="generateReportBtn" class="button-teal text-sm py-1.5 px-3">Generate Report</button> <button id="deleteDossierBtn" class="button-danger text-sm py-1.5 px-3">Delete This Dossier</button> </div> </section>
                <div class="flex-grow overflow-y-auto space-y-6 pr-2 -mr-2"> 
                    <section id="subjectProfileSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Subject Profile</h3> <form id="addProfileItemForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> <div><label for="profileItemType" class="block text-xs font-medium text-gray-600">Type*</label><select id="profileItemType" class="input-field bg-white text-sm"><option value="Full Name">Full Name</option><option value="Alias">Alias</option><option value="Email">Email</option><option value="Phone">Phone</option><option value="Social Media Profile">Social Media Profile</option><option value="Website">Website</option><option value="Address">Address</option><option value="Custom Field">Custom Field</option><option value="Other">Other</option></select></div> <div><label for="profileItemLabel" class="block text-xs font-medium text-gray-600">Label (if Custom/Other)</label><input type="text" id="profileItemLabel" class="input-field text-sm hidden" placeholder="e.g., Work Phone, Twitter"></div> </div> <div><label for="profileItemValue" class="block text-xs font-medium text-gray-600">Value*</label><input type="text" id="profileItemValue" required class="input-field text-sm" placeholder="Enter profile data"></div> <div><label for="profileItemNotes" class="block text-xs font-medium text-gray-600">Notes</label><textarea id="profileItemNotes" rows="2" class="input-field text-sm" placeholder="Context or source..."></textarea></div> <button type="submit" class="button-primary text-sm py-1.5 px-3">Add Profile Item</button> </form> <div id="subjectProfileList" class="space-y-2 max-h-60 overflow-y-auto pr-1"> <p class="text-sm text-gray-500 italic px-3">No profile items added. Use the form above to add key information.</p> </div> </section>
                    <section id="searchLogSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Investigation Search Log</h3> <form id="addSearchLogForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div><label for="searchQueryText" class="block text-xs font-medium text-gray-600">Search Query*</label><input type="text" id="searchQueryText" required class="input-field text-sm" placeholder="e.g., 'John Doe' site:twitter.com"></div> <div><label for="searchPlatform" class="block text-xs font-medium text-gray-600">Platform/Tool Used*</label><input type="text" id="searchPlatform" required class="input-field text-sm" placeholder="e.g., Google, Twitter, OSINT Tool X"></div> <div><label for="searchLogNotes" class="block text-xs font-medium text-gray-600">Notes</label><textarea id="searchLogNotes" rows="2" class="input-field text-sm" placeholder="Purpose or key findings..."></textarea></div> <button type="submit" class="button-sky text-sm py-1.5 px-3">Log Search Query</button> </form> <div id="searchLogList" class="space-y-2 max-h-60 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No search queries logged. Use the form above to document your process.</p></div> </section>
                    <section id="envDetailsSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Investigation Environment Details</h3> <form id="addEnvDetailForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> <div><label for="envDetailType" class="block text-xs font-medium text-gray-600">Detail Type*</label><select id="envDetailType" class="input-field bg-white text-sm"><option value="Virtual Machine">Virtual Machine</option><option value="Operating System">Operating System</option><option value="Browser Profile">Browser Profile</option><option value="VPN Status">VPN Status</option><option value="IP Address (Current)">IP Address (Current)</option><option value="OSINT Tool & Version">OSINT Tool & Version</option><option value="Custom Detail">Custom Detail</option></select></div> <div><label for="envDetailValue" class="block text-xs font-medium text-gray-600">Value/Specification*</label><input type="text" id="envDetailValue" required class="input-field text-sm" placeholder="e.g., Ubuntu VM, Firefox Profile X"></div> </div> <div><label for="envDetailNotes" class="block text-xs font-medium text-gray-600">Notes</label><textarea id="envDetailNotes" rows="2" class="input-field text-sm" placeholder="Configurations or context..."></textarea></div> <button type="submit" class="button-indigo text-sm py-1.5 px-3">Log Environment Detail</button> </form> <div id="envDetailsList" class="space-y-2 max-h-60 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No environment details logged. Use the form above.</p></div> </section>
                    <section id="notesSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Notes</h3> <form id="addNoteForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div><label for="noteContent" class="block text-sm font-medium text-gray-600">Add New Note</label><textarea id="noteContent" name="noteContent" rows="3" required class="input-field" placeholder="Enter your observations, analysis, or next steps..."></textarea></div> <div id="linkableArtifactsContainer" class="space-y-1 max-h-32 overflow-y-auto border border-gray-200 p-2 rounded-md bg-white"><p class="text-xs text-gray-500 italic p-1">Select a dossier with artifacts to link them here.</p></div> <button type="submit" class="button-success">Add Note</button> </form> <div id="notesList" class="space-y-3 max-h-96 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No notes added yet. Use the form above.</p></div> </section>
                    <section id="artifactsSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> 
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Collected Artifacts</h3> 
                        <div class="mb-6 p-3 bg-slate-50 rounded-lg border">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Import List of URLs</h4>
                            <p class="text-xs text-gray-600 mb-3">Paste URLs below (one per line) to add them as URL-type artifacts.</p>
                            <div class="space-y-3">
                                <div><label for="bulkUrlInput" class="block text-xs font-medium text-gray-600">URLs (one per line)*</label><textarea id="bulkUrlInput" rows="3" class="input-field text-sm" placeholder="https://example.com/page1&#10;http://anothersite.org/item"></textarea></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div><label for="bulkUrlCategoryInput" class="block text-xs font-medium text-gray-600">Default Category</label><input type="text" id="bulkUrlCategoryInput" value="Pasted URL" class="input-field text-sm"></div>
                                    <div><label for="bulkUrlDescriptionInput" class="block text-xs font-medium text-gray-600">Default Description</label><textarea id="bulkUrlDescriptionInput" rows="1" class="input-field text-sm" placeholder="Batch imported URLs"></textarea></div>
                                </div>
                                <button id="addBulkUrlsBtn" class="button-teal w-full text-sm py-1.5 px-3">Add URLs as Artifacts</button>
                            </div>
                        </div>
                        <div class="mb-6 p-3 bg-slate-50 rounded-lg border"> 
                            <h4 class="text-md font-semibold text-gray-700 mb-2" title="Supports: JSON (array of objects), TXT/CSV (each line becomes an artifact), or single Image files (for EXIF extraction).">Import Artifacts from File <span class="text-gray-400 text-xs">(hover for info)</span></h4>
                            <div class="space-y-3"> 
                                <div><label for="importFileInput" class="block text-xs font-medium text-gray-600">Select File</label><input type="file" id="importFileInput" accept=".json,.txt,.csv,image/*" class="file-input-field"></div> 
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> 
                                    <div><label for="importArtifactTypeInput" class="block text-xs font-medium text-gray-600">Default Type</label><input type="text" id="importArtifactTypeInput" value="Imported Data" class="input-field text-sm"></div> 
                                    <div><label for="importCategoryInput" class="block text-xs font-medium text-gray-600">Default Category</label><input type="text" id="importCategoryInput" value="Imported Batch" class="input-field text-sm"></div> 
                                </div> 
                                <button id="processImportBtn" class="button-teal w-full text-sm py-1.5 px-3">Process Imported File</button> 
                            </div> 
                        </div> 
                        <form id="addArtifactForm" class="space-y-3 bg-slate-50 p-3 rounded-lg border"> 
                             <h4 class="text-md font-semibold text-gray-700">Add New Artifact Manually</h4> 
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> 
                                 <div><label for="artifactName" class="block text-xs font-medium text-gray-600">Name*</label><input type="text" id="artifactName" required class="input-field text-sm"></div> 
                                 <div><label for="artifactType" class="block text-xs font-medium text-gray-600">Type*</label><select id="artifactType" required class="input-field bg-white text-sm"><option>URL</option><option>Image</option><option>Screenshot</option><option>Video</option><option>Document</option><option>Web Archive Link</option><option>Social Network Post</option><option>Broadcast Stream</option><option>Text Snippet</option><option>Other</option></select></div> 
                             </div> 
                             <div><label for="artifactSource" class="block text-xs font-medium text-gray-600">Source / Link / Filename*</label><input type="text" id="artifactSource" required class="input-field text-sm" placeholder="http://example.com or image.jpg"></div> 
                             <div><label for="artifactCategory" class="block text-xs font-medium text-gray-600">Category</label><input type="text" id="artifactCategory" class="input-field text-sm" placeholder="e.g., Social Media, Evidence"></div> 
                             <div><label for="artifactDescription" class="block text-xs font-medium text-gray-600">Description / Annotation</label><textarea id="artifactDescription" rows="2" class="input-field text-sm" placeholder="Context, collection method..."></textarea></div> 
                             <div class="flex items-center"><input type="checkbox" id="artifactMetadataStripped" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2"><label for="artifactMetadataStripped" class="text-sm text-gray-700">Metadata was stripped</label></div> 
                             <button type="submit" class="button-purple w-full text-sm py-1.5 px-3">Add Artifact</button> 
                        </form> 
                        <div id="artifactsList" class="mt-4 space-y-3 max-h-96 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No artifacts collected. Use the forms above.</p></div> 
                    </section>
                </div>
            </div>
        </div>
    </div>
    <style>
      .button-secondary { @apply button-base bg-slate-200 hover:bg-slate-300 text-slate-700 focus:ring-slate-400; }
      .button-danger { @apply button-base bg-red-600 hover:bg-red-700 text-white focus:ring-red-500; }
    </style>
</body>
</html>
