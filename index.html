<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigation Dossier Manager v2 - Final Polished</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            Timestamp,
            serverTimestamp,
            arrayUnion, 
            arrayRemove 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Application Configuration ---
        // IMPORTANT: REPLACE THE PLACEHOLDER VALUES BELOW WITH YOUR ACTUAL FIREBASE PROJECT CONFIGURATION
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyDKhrmjIksOT33GXnHr9hUFhBytWuhX83c",
  authDomain: "invdosmgr-backend-v2.firebaseapp.com",
  projectId: "invdosmgr-backend-v2",
  storageBucket: "invdosmgr-backend-v2.firebasestorage.app",
  messagingSenderId: "974909853701",
  appId: "1:974909853701:web:6f3d5f7a2bef40ff558c6c"
}; 
        // This appId is used for structuring Firestore paths, ensure it's consistent if you modify it.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dossier-app-v2-final-polished'; 

        // --- Firebase Globals ---
        let app, auth, db, currentUserId = null, dossiersCollectionRef;
        let dossiersListener = null; // Real-time listener for the dossiers collection

        // --- UI Element References (Grouped for clarity) ---
        // General UI & Feedback
        const loadingIndicator = document.getElementById('loadingIndicator');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageDisplayDiv = document.getElementById('messageDisplayDiv');
        const noDossierSelectedMessage = document.getElementById('noDossierSelectedMessage');
        const selectedDossierDiv = document.getElementById('selectedDossier');

        // Dossier Creation & List
        const createDossierForm = document.getElementById('createDossierForm');
        const subjectNameInput = document.getElementById('subjectName');
        const caseIdInput = document.getElementById('caseId');
        const statusInput = document.getElementById('status');
        const summaryInput = document.getElementById('summary');
        const dossiersListDiv = document.getElementById('dossiersList');
        
        // Selected Dossier Actions & Details Display
        const dossierDetailsDiv = document.getElementById('dossierDetails');
        const deleteDossierBtn = document.getElementById('deleteDossierBtn');
        const generateReportBtn = document.getElementById('generateReportBtn');

        // Subject Profile Section
        const addProfileItemForm = document.getElementById('addProfileItemForm');
        const profileItemTypeInput = document.getElementById('profileItemType');
        const profileItemLabelInput = document.getElementById('profileItemLabel');
        const profileItemValueInput = document.getElementById('profileItemValue');
        const profileItemNotesInput = document.getElementById('profileItemNotes');
        const subjectProfileListDiv = document.getElementById('subjectProfileList');

        // Search Log Section
        const addSearchLogForm = document.getElementById('addSearchLogForm');
        const searchQueryTextInput = document.getElementById('searchQueryText');
        const searchPlatformInput = document.getElementById('searchPlatform');
        const searchLogNotesInput = document.getElementById('searchLogNotes');
        const searchLogListDiv = document.getElementById('searchLogList');

        // Environment Details Section
        const addEnvDetailForm = document.getElementById('addEnvDetailForm');
        const envDetailTypeInput = document.getElementById('envDetailType');
        const envDetailValueInput = document.getElementById('envDetailValue');
        const envDetailNotesInput = document.getElementById('envDetailNotes');
        const envDetailsListDiv = document.getElementById('envDetailsList');
        
        // Notes Section
        const notesListDiv = document.getElementById('notesList');
        const addNoteForm = document.getElementById('addNoteForm');
        const noteContentInput = document.getElementById('noteContent');
        const linkableArtifactsContainer = document.getElementById('linkableArtifactsContainer'); 

        // Artifacts Section (Manual Add)
        const artifactsListDiv = document.getElementById('artifactsList');
        const addArtifactForm = document.getElementById('addArtifactForm');
        const artifactNameInput = document.getElementById('artifactName');
        const artifactTypeInput = document.getElementById('artifactType');
        const artifactSourceInput = document.getElementById('artifactSource');
        const artifactCategoryInput = document.getElementById('artifactCategory');
        const artifactDescriptionInput = document.getElementById('artifactDescription');
        const artifactMetadataStrippedInput = document.getElementById('artifactMetadataStripped');

        // Artifacts Section (File Import)
        const importFileInput = document.getElementById('importFileInput');
        const importArtifactTypeInput = document.getElementById('importArtifactTypeInput');
        const importCategoryInput = document.getElementById('importCategoryInput');
        const processImportBtn = document.getElementById('processImportBtn');

        // Artifacts Section (Bulk URL Import)
        const bulkUrlInput = document.getElementById('bulkUrlInput');
        const bulkUrlCategoryInput = document.getElementById('bulkUrlCategoryInput');
        const bulkUrlDescriptionInput = document.getElementById('bulkUrlDescriptionInput');
        const addBulkUrlsBtn = document.getElementById('addBulkUrlsBtn');

        // Modals
        const editNoteLinksModal = document.getElementById('editNoteLinksModal');
        const editNoteModalContent = document.getElementById('editNoteModalContent');
        const editNoteModalArtifactsContainer = document.getElementById('editNoteModalArtifactsContainer');
        const saveNoteLinksBtn = document.getElementById('saveNoteLinksBtn');
        const cancelEditNoteLinksBtn = document.getElementById('cancelEditNoteLinksBtn');
        let currentEditingNoteId = null; 

        const confirmModal = document.getElementById('confirmModal');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const modalMessage = document.getElementById('modalMessage');
        const modalTitle = document.getElementById('modalTitle');
        let confirmActionCallback = null; 

        // --- Application State ---
        let selectedDossierId = null;    
        let currentDossiers = [];       

        // --- Global Error Handlers ---
        window.addEventListener('error', function(event) {
            console.error('GLOBAL UNHANDLED ERROR:', event.message, event.filename, event.lineno, event.colno, event.error);
            displayUserMessage("A critical application error occurred: " + event.message + ". Please try refreshing the page. Check console for details.", true);
            showLoading(false); 
        });
        window.addEventListener('unhandledrejection', function(event) {
            console.error('GLOBAL UNHANDLED PROMISE REJECTION:', event.reason);
            const reasonMessage = event.reason?.message || event.reason || "Unknown promise rejection";
            displayUserMessage("An unexpected error occurred (Promise Rejection): " + reasonMessage + ". Please check console.", true);
            showLoading(false); 
        });

        // --- Utility Functions ---
        function showLoading(isLoading) { if(loadingIndicator) loadingIndicator.classList.toggle('hidden', !isLoading); }
        function displayUserMessage(message, isError = true) { 
            if(!messageDisplayDiv) { console.warn("MessageDisplayDiv not found for:", message); return; }
            messageDisplayDiv.textContent = message; 
            messageDisplayDiv.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'opacity-0');
            messageDisplayDiv.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
            setTimeout(() => { 
                messageDisplayDiv.classList.add('opacity-0');
                setTimeout(() => {
                    messageDisplayDiv.classList.add('hidden'); 
                    messageDisplayDiv.textContent = ''; 
                }, 500); 
            }, 4500); 
            if(isError) console.error("UserMessage (Error):", message); else console.log("UserMessage (Success):", message);
        }
        function generateCaseId() { return `CASE-${Date.now().toString().slice(-6)}-${Math.random().toString(36).substring(2, 7).toUpperCase()}`; }
        function generateUUID() { return crypto.randomUUID(); } 
        function escapeHTML(str) {
            if (typeof str !== 'string') return String(str);
            return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebaseServices() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    displayUserMessage("Firebase configuration is missing or incomplete. Please update the firebaseConfig object in the script.", true);
                    console.error("Firebase config error: API Key is a placeholder or missing. Update required in index.html.");
                    showLoading(false);
                    return;
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                showLoading(true); 
                if(userIdDisplay) userIdDisplay.textContent = "User ID: Initializing...";
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if(userIdDisplay) userIdDisplay.textContent = `User ID: ${currentUserId}`;
                        dossiersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/dossiers`);
                        loadDossiers(); 
                    } else {
                        console.log("onAuthStateChanged: User is signed out or auth state not yet determined.");
                        currentUserId = null;
                        if (dossiersListener) { dossiersListener(); dossiersListener = null; }
                        currentDossiers = []; renderDossiersList(currentDossiers); 
                        resetSelectedDossierView(); 
                        if(userIdDisplay) userIdDisplay.textContent = "User ID: Authenticating...";
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting custom token sign-in...");
                    await signInWithCustomToken(auth, __initial_auth_token)
                       .then(() => console.log("Custom token sign-in successful or user already signed in."))
                       .catch(e => { displayUserMessage(`Custom token sign-in failed: ${e.message}`); if(userIdDisplay) userIdDisplay.textContent = "User ID: Auth Failed"; showLoading(false); });
                } else {
                    console.log("No custom token found, attempting anonymous sign-in...");
                    await signInAnonymously(auth)
                       .then(() => console.log("Anonymous sign-in successful or user already signed in."))
                       .catch(e => { displayUserMessage(`Anonymous sign-in failed: ${e.message}`); if(userIdDisplay) userIdDisplay.textContent = "User ID: Auth Failed"; showLoading(false); });
                }
            } catch (error) { 
                displayUserMessage("Firebase core initialization failed: " + error.message); 
                if(userIdDisplay) userIdDisplay.textContent = "User ID: Init Failed"; 
                showLoading(false); 
            }
        }

        // --- Dossier Management Functions ---
        async function handleCreateDossier(event) {
            event.preventDefault();
            if (!currentUserId) return displayUserMessage("User not authenticated. Cannot create dossier.");
            showLoading(true);
            const subjectName = subjectNameInput.value.trim();
            let caseId = caseIdInput.value.trim() || generateCaseId();
            if (!subjectName) { displayUserMessage("Subject Name is required."); showLoading(false); return; }
            try {
                const newDossierData = {
                    subjectName, caseId, status: statusInput.value, summary: summaryInput.value.trim(),
                    createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
                    subjectProfile: [], searchLogs: [], environmentDetails: [], notes: [], artifacts: [] 
                };
                await addDoc(dossiersCollectionRef, newDossierData);
                if(createDossierForm) createDossierForm.reset(); 
                if(caseIdInput) caseIdInput.value = '';
                displayUserMessage(`Dossier for "${escapeHTML(subjectName)}" created successfully.`, false);
            } catch (e) { displayUserMessage("Failed to create dossier: " + e.message); } 
            finally { showLoading(false); }
        }

        function loadDossiers() {
            if (!currentUserId || !dossiersCollectionRef) { 
                console.warn("Cannot load dossiers: User not authenticated or Firestore collection reference is not set."); 
                if(dossiersListDiv) dossiersListDiv.innerHTML = '<p class="text-gray-500 italic p-4">Authentication required to load dossiers.</p>';
                showLoading(false); return; 
            }
            showLoading(true);
            if (dossiersListener) {
                console.log("Unsubscribing from previous dossiers listener.");
                dossiersListener(); 
                dossiersListener = null;
            }
            
            console.log("Setting up new dossiers listener for user:", currentUserId);
            dossiersListener = onSnapshot(dossiersCollectionRef, (querySnapshot) => {
                console.log("Dossiers snapshot received, processing...");
                const previousSelectedDossierId = selectedDossierId;

                currentDossiers = [];
                querySnapshot.forEach((doc) => currentDossiers.push({ id: doc.id, ...doc.data() }));
                renderDossiersList(currentDossiers); 
                
                if (previousSelectedDossierId) { 
                    const updatedSelectedDossier = currentDossiers.find(d => d.id === previousSelectedDossierId);
                    if (updatedSelectedDossier) { 
                        console.log("Re-rendering selected dossier:", previousSelectedDossierId);
                        renderSelectedDossier(updatedSelectedDossier); 
                    } else { 
                        console.warn(`Previously selected dossier ID ${previousSelectedDossierId} no longer found in updated list. Current dossier IDs: ${currentDossiers.map(d=>d.id).join(', ')}. Resetting view.`);
                        resetSelectedDossierView(); 
                    }
                }
                showLoading(false); 
            }, (e) => { 
                displayUserMessage("Error loading dossiers: " + e.message + ". Check console.", true); 
                console.error("Firestore onSnapshot error:", e);
                if(dossiersListDiv) dossiersListDiv.innerHTML = '<p class="text-red-600 p-4">Error loading dossiers. Please try refreshing.</p>';
                showLoading(false); 
            });
        }
        
        function resetSelectedDossierView() {
             selectedDossierId = null; 
             currentEditingNoteId = null;
             if(selectedDossierDiv) selectedDossierDiv.classList.add('hidden'); 
             if(noDossierSelectedMessage) noDossierSelectedMessage.classList.remove('hidden');
             if(editNoteLinksModal) editNoteLinksModal.classList.add('hidden'); 
             updateLinkableArtifactsCheckboxes([]); 
             if (currentDossiers && currentDossiers.length > 0) {
                renderDossiersList(currentDossiers);
             } else {
                if(dossiersListDiv) dossiersListDiv.innerHTML = '<p class="text-gray-500 italic p-4 text-center">No dossiers available.<br>Use the form above to create one.</p>';
             }
        }

        function renderDossiersList(dossiers) {
            if(!dossiersListDiv) return; 
            dossiersListDiv.innerHTML = '';
            if (dossiers.length === 0) { 
                dossiersListDiv.innerHTML = '<p class="text-gray-500 italic p-4 text-center">No dossiers found.<br>Use the form above to create one.</p>'; 
                return; 
            }
            const ul = document.createElement('ul'); ul.className = 'space-y-2';
            const sortedDossiers = [...dossiers].sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            sortedDossiers.forEach(dossier => {
                const li = document.createElement('li');
                li.className = `p-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out cursor-pointer ${selectedDossierId === dossier.id ? 'bg-blue-600 text-white ring-2 ring-blue-700 ring-offset-2 ring-offset-slate-100' : 'bg-white hover:bg-slate-50'}`;
                li.innerHTML = `
                    <h3 class="font-semibold text-lg truncate" title="${escapeHTML(dossier.subjectName)}">${escapeHTML(dossier.subjectName)}</h3>
                    <p class="text-sm ${selectedDossierId === dossier.id ? 'text-blue-200' : 'text-gray-600'}">ID: ${escapeHTML(dossier.caseId)}</p>
                    <p class="text-xs ${selectedDossierId === dossier.id ? 'text-blue-300' : 'text-gray-400'}">Status: <span class="font-medium">${escapeHTML(dossier.status)}</span></p>`;
                li.addEventListener('click', () => selectDossier(dossier.id));
                ul.appendChild(li);
            });
            dossiersListDiv.appendChild(ul);
        }

        function selectDossier(dossierId) {
            if (!dossierId) { console.warn("selectDossier called with no ID"); return; }
            showLoading(true); 
            selectedDossierId = dossierId; 
            currentEditingNoteId = null; 
            if(editNoteLinksModal) editNoteLinksModal.classList.add('hidden'); 
            if(noDossierSelectedMessage) noDossierSelectedMessage.classList.add('hidden');
            if(selectedDossierDiv) selectedDossierDiv.classList.remove('hidden');
            
            const dossier = currentDossiers.find(d => d.id === dossierId);
            if (dossier) {
                 renderSelectedDossier(dossier);
                 renderDossiersList(currentDossiers);
                 showLoading(false);
            } else { 
                displayUserMessage("Could not find the selected dossier. It might have been deleted or an error occurred."); 
                resetSelectedDossierView(); 
                showLoading(false); 
            }
        }
        
        function renderSelectedDossier(dossier) {
            if (!dossier) { console.warn("renderSelectedDossier called with no dossier data."); resetSelectedDossierView(); return; }
            renderDossierDetails(dossier);
            renderSubjectProfile(dossier.subjectProfile || []);
            renderSearchLogs(dossier.searchLogs || []);
            renderEnvironmentDetails(dossier.environmentDetails || []);
            renderNotesList(dossier.notes || [], dossier.artifacts || []);
            renderArtifactsList(dossier.artifacts || []);
            updateLinkableArtifactsCheckboxes(dossier.artifacts || []);
        }

        function renderDossierDetails(dossier) { 
            if(!dossierDetailsDiv) return;
            dossierDetailsDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-3 text-gray-800">${escapeHTML(dossier.subjectName)}</h2>
                <div class="space-y-1 text-sm mb-3">
                    <p><strong class="font-medium text-gray-600 w-24 inline-block">Case ID:</strong> ${escapeHTML(dossier.caseId)}</p>
                    <p><strong class="font-medium text-gray-600 w-24 inline-block">Status:</strong> <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${getStatusColor(dossier.status)}">${escapeHTML(dossier.status)}</span></p>
                </div>
                <div class="mt-2">
                    <strong class="font-medium text-gray-600 text-sm block mb-1">Summary:</strong>
                    <div class="text-gray-700 bg-slate-50 p-3 rounded-md whitespace-pre-wrap border border-slate-200 text-sm">${escapeHTML(dossier.summary || 'N/A')}</div>
                </div>
                <p class="text-xs text-gray-500 mt-3">Created: ${dossier.createdAt?.toDate().toLocaleString() || 'N/A'}</p>
                <p class="text-xs text-gray-500">Last Updated: ${dossier.updatedAt?.toDate().toLocaleString() || 'N/A'}</p>`;
        }
        function getStatusColor(status) { 
            const s = status?.toLowerCase();
            if (s === 'open') return 'bg-green-100 text-green-700 border border-green-200';
            if (s === 'closed') return 'bg-red-100 text-red-700 border border-red-200';
            if (s === 'pending') return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
            if (s === 'in progress') return 'bg-blue-100 text-blue-700 border border-blue-200';
            return 'bg-gray-100 text-gray-700 border border-gray-200';
        }
        
        // --- Subject Profile Functions ---
        async function handleAddProfileItem(event) {
            event.preventDefault();
            if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first.");
            const itemType = profileItemTypeInput.value;
            const itemLabel = profileItemLabelInput.value.trim();
            const itemValue = profileItemValueInput.value.trim();
            const itemNotes = profileItemNotesInput.value.trim();
            if (!itemType || !itemValue) { displayUserMessage("Profile Item Type and Value are required."); return; }
            showLoading(true);
            const newProfileItem = { 
                profileItemId: generateUUID(), itemType, 
                itemLabel: itemLabel || (['Custom Field', 'Social Media Profile', 'Other'].includes(itemType) ? itemType : ''), // Default label for specific types if user leaves it blank
                itemValue, itemNotes: itemNotes || '', addedAt: Timestamp.now() 
            };
            try {
                const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                await updateDoc(ref, { subjectProfile: arrayUnion(newProfileItem), updatedAt: serverTimestamp() });
                if(addProfileItemForm) addProfileItemForm.reset(); 
                if(profileItemLabelInput) {
                    profileItemLabelInput.value = ''; 
                    profileItemLabelInput.classList.add('hidden');
                }
                displayUserMessage("Profile item added.", false);
            } catch (e) { displayUserMessage("Failed to add profile item: " + e.message); } finally { showLoading(false); }
        }
        async function handleDeleteProfileItem(profileItemId) {
            if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first.");
            confirmActionCallback = async () => {
                showLoading(true);
                try {
                    const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const itemToRemove = (snap.data().subjectProfile || []).find(item => item.profileItemId === profileItemId);
                        if (itemToRemove) {
                            await updateDoc(ref, { subjectProfile: arrayRemove(itemToRemove), updatedAt: serverTimestamp() });
                            displayUserMessage("Profile item deleted.", false);
                        } else displayUserMessage("Profile item not found for deletion.");
                    } else displayUserMessage("Dossier not found.");
                } catch (e) { displayUserMessage("Failed to delete profile item: " + e.message); } finally { showLoading(false); }
            };
            modalTitle.textContent = "Delete Profile Item"; modalMessage.textContent = "Are you sure you want to delete this profile item?";
            if(confirmModal) confirmModal.classList.remove('hidden');
        }
        function renderSubjectProfile(profileItems) {
            if(!subjectProfileListDiv) return;
            subjectProfileListDiv.innerHTML = '';
            if (!profileItems || profileItems.length === 0) { subjectProfileListDiv.innerHTML = '<p class="text-sm text-gray-500 italic px-3">No profile items added. Use the form above to add key information about the subject.</p>'; return; }
            const ul = document.createElement('ul'); ul.className = 'space-y-2';
            profileItems.sort((a,b) => (a.addedAt?.toDate() || 0) - (b.addedAt?.toDate() || 0)).forEach(item => {
                const li = document.createElement('li'); li.className = 'p-3 bg-slate-50 rounded-md border border-slate-200 text-sm hover:shadow-sm transition-shadow';
                let valueDisplay = `<span class="text-gray-800 break-all">${escapeHTML(item.itemValue)}</span>`;
                if (item.itemType === "Email") valueDisplay = `<a href="mailto:${escapeHTML(item.itemValue)}" class="text-blue-600 hover:underline break-all">${escapeHTML(item.itemValue)}</a>`;
                else if (item.itemType === "Phone") valueDisplay = `<a href="tel:${escapeHTML(item.itemValue)}" class="text-blue-600 hover:underline break-all">${escapeHTML(item.itemValue)}</a>`;
                else if (item.itemType === "Website" || item.itemType === "Social Media Profile") {
                    if(typeof item.itemValue === 'string' && (item.itemValue.startsWith('http://') || item.itemValue.startsWith('https://'))) valueDisplay = `<a href="${escapeHTML(item.itemValue)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline break-all">${escapeHTML(item.itemValue)}</a>`;
                    else valueDisplay = `<span class="text-gray-800 break-all">${escapeHTML(item.itemValue)}</span>`; // Display as text if not a valid URL
                }
                li.innerHTML = `<div class="flex justify-between items-start"><div><strong class="font-medium text-gray-700">${escapeHTML(item.itemLabel || item.itemType)}:</strong> ${valueDisplay}</div><button class="delete-item-btn" data-id="${item.profileItemId}" aria-label="Delete profile item">&times;</button></div>${item.itemNotes ? `<p class="text-xs text-gray-600 mt-1 pt-1 border-t border-slate-200">${escapeHTML(item.itemNotes)}</p>` : ''}`;
                const deleteBtn = li.querySelector('.delete-item-btn');
                if(deleteBtn) deleteBtn.addEventListener('click', (e) => handleDeleteProfileItem(e.currentTarget.dataset.id));
                ul.appendChild(li);
            });
            subjectProfileListDiv.appendChild(ul);
        }
        
        // --- Search Log Functions ---
        async function handleAddSearchLog(event) {
            event.preventDefault();
            if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first.");
            const queryText = searchQueryTextInput.value.trim(); const platformUsed = searchPlatformInput.value.trim(); const logNotes = searchLogNotesInput.value.trim();
            if (!queryText || !platformUsed) { displayUserMessage("Search Query and Platform Used are required."); return; }
            showLoading(true);
            const newLog = { logId: generateUUID(), queryText, platformUsed, logNotes: logNotes || '', timestamp: Timestamp.now() };
            try {
                const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                await updateDoc(ref, { searchLogs: arrayUnion(newLog), updatedAt: serverTimestamp() });
                if(addSearchLogForm) addSearchLogForm.reset(); displayUserMessage("Search log added.", false);
            } catch (e) { displayUserMessage("Failed to add search log: " + e.message); } finally { showLoading(false); }
        }
        async function handleDeleteSearchLog(logId) {
             if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first.");
            confirmActionCallback = async () => {
                showLoading(true);
                try {
                    const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const logToRemove = (snap.data().searchLogs || []).find(log => log.logId === logId);
                        if (logToRemove) { await updateDoc(ref, { searchLogs: arrayRemove(logToRemove), updatedAt: serverTimestamp() }); displayUserMessage("Search log deleted.", false); }
                        else displayUserMessage("Search log not found for deletion.");
                    } else displayUserMessage("Dossier not found.");
                } catch (e) { displayUserMessage("Failed to delete search log: " + e.message); } finally { showLoading(false); }
            };
            modalTitle.textContent = "Delete Search Log"; modalMessage.textContent = "Are you sure you want to delete this log entry?"; if(confirmModal) confirmModal.classList.remove('hidden');
        }
        function renderSearchLogs(searchLogs) {
            if(!searchLogListDiv) return;
            searchLogListDiv.innerHTML = '';
            if (!searchLogs || searchLogs.length === 0) { searchLogListDiv.innerHTML = '<p class="text-sm text-gray-500 italic px-3">No search queries logged. Use the form above to document your process.</p>'; return; }
            const ul = document.createElement('ul'); ul.className = 'space-y-2';
            [...searchLogs].sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).forEach(log => {
                const li = document.createElement('li'); li.className = 'p-3 bg-slate-50 rounded-md border border-slate-200 text-sm hover:shadow-sm transition-shadow';
                const logDate = log.timestamp?.toDate() ? log.timestamp.toDate().toLocaleString() : 'Date N/A';
                li.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-medium text-gray-700">Query: <span class="font-normal text-gray-800 break-all">${escapeHTML(log.queryText)}</span></p><p class="text-xs text-gray-600">Platform: <span class="font-normal">${escapeHTML(log.platformUsed)}</span></p></div><button class="delete-item-btn" data-id="${log.logId}" aria-label="Delete search log">&times;</button></div>${log.logNotes ? `<p class="text-xs text-gray-600 mt-1 pt-1 border-t border-slate-200">${escapeHTML(log.logNotes)}</p>` : ''}<p class="text-xs text-gray-400 text-right mt-1">${escapeHTML(logDate)}</p>`;
                const deleteBtn = li.querySelector('.delete-item-btn');
                if(deleteBtn) deleteBtn.addEventListener('click', (e) => handleDeleteSearchLog(e.currentTarget.dataset.id));
                ul.appendChild(li);
            });
            searchLogListDiv.appendChild(ul);
        }

        // --- Environment Detail Functions ---
        async function handleAddEnvDetail(event) {
            event.preventDefault();
            if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first.");
            const detailType = envDetailTypeInput.value; const detailValue = envDetailValueInput.value.trim(); const detailNotes = envDetailNotesInput.value.trim();
            if (!detailType || !detailValue) { displayUserMessage("Environment Detail Type and Value are required."); return; }
            showLoading(true);
            const newEnvDetail = { detailId: generateUUID(), detailType, detailValue, detailNotes: detailNotes || '', timestamp: Timestamp.now() };
            try {
                const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                await updateDoc(ref, { environmentDetails: arrayUnion(newEnvDetail), updatedAt: serverTimestamp() });
                if(addEnvDetailForm) addEnvDetailForm.reset(); displayUserMessage("Environment detail logged.", false);
            } catch (e) { displayUserMessage("Failed to add environment detail: " + e.message); } finally { showLoading(false); }
        }
        async function handleDeleteEnvDetail(detailId) {
             if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first.");
            confirmActionCallback = async () => {
                showLoading(true);
                try {
                    const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const detailToRemove = (snap.data().environmentDetails || []).find(detail => detail.detailId === detailId);
                        if (detailToRemove) { await updateDoc(ref, { environmentDetails: arrayRemove(detailToRemove), updatedAt: serverTimestamp() }); displayUserMessage("Environment detail deleted.", false); }
                        else displayUserMessage("Environment detail not found for deletion.");
                    } else displayUserMessage("Dossier not found.");
                } catch (e) { displayUserMessage("Failed to delete environment detail: " + e.message); } finally { showLoading(false); }
            };
            modalTitle.textContent = "Delete Environment Detail"; modalMessage.textContent = "Are you sure?"; if(confirmModal) confirmModal.classList.remove('hidden');
        }
        function renderEnvironmentDetails(envDetails) {
            if(!envDetailsListDiv) return;
            envDetailsListDiv.innerHTML = '';
            if (!envDetails || envDetails.length === 0) { envDetailsListDiv.innerHTML = '<p class="text-sm text-gray-500 italic px-3">No environment details logged. Use the form above.</p>'; return; }
            const ul = document.createElement('ul'); ul.className = 'space-y-2';
            [...envDetails].sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).forEach(detail => {
                const li = document.createElement('li'); li.className = 'p-3 bg-slate-50 rounded-md border border-slate-200 text-sm hover:shadow-sm transition-shadow';
                const detailDate = detail.timestamp?.toDate() ? detail.timestamp.toDate().toLocaleString() : 'Date N/A';
                li.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-medium text-gray-700">${escapeHTML(detail.detailType)}: <span class="font-normal text-gray-800 break-all">${escapeHTML(detail.detailValue)}</span></p></div><button class="delete-item-btn" data-id="${detail.detailId}" aria-label="Delete environment detail">&times;</button></div>${detail.detailNotes ? `<p class="text-xs text-gray-600 mt-1 pt-1 border-t border-slate-200">${escapeHTML(detail.detailNotes)}</p>` : ''}<p class="text-xs text-gray-400 text-right mt-1">${escapeHTML(detailDate)}</p>`;
                const deleteBtn = li.querySelector('.delete-item-btn');
                if(deleteBtn) deleteBtn.addEventListener('click', (e) => handleDeleteEnvDetail(e.currentTarget.dataset.id));
                ul.appendChild(li);
            });
            envDetailsListDiv.appendChild(ul);
        }

        // --- Notes Section Functions ---
        function updateLinkableArtifactsCheckboxes(artifacts, containerElement = linkableArtifactsContainer, existingLinks = []) { 
            if (!containerElement) return;
            containerElement.innerHTML = ''; 
            if (!artifacts || artifacts.length === 0) {
                containerElement.innerHTML = '<p class="text-xs text-gray-500 italic p-1">No artifacts available in this dossier to link.</p>';
                return;
            }
            const fieldset = document.createElement('fieldset');
            const legend = document.createElement('legend'); legend.className = 'text-sm font-medium text-gray-600 mb-1'; legend.textContent = 'Link Artifacts:'; fieldset.appendChild(legend);
            artifacts.forEach(artifact => {
                const div = document.createElement('div'); div.className = 'flex items-center';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `${containerElement.id}-link-artifact-${artifact.artifactId}`; checkbox.value = artifact.artifactId;
                checkbox.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2 artifact-link-checkbox';
                if (existingLinks.includes(artifact.artifactId)) checkbox.checked = true;
                const label = document.createElement('label'); label.htmlFor = `${containerElement.id}-link-artifact-${artifact.artifactId}`; label.textContent = `${escapeHTML(artifact.name)} (${escapeHTML(artifact.type)})`; label.className = 'text-sm text-gray-700 select-none';
                div.appendChild(checkbox); div.appendChild(label); fieldset.appendChild(div);
            });
            containerElement.appendChild(fieldset);
        }
        async function handleAddNote(event) {
            event.preventDefault();
            if (!selectedDossierId || !currentUserId) return displayUserMessage("Select a dossier first to add a note.");
            if (!addNoteForm || !noteContentInput || !linkableArtifactsContainer) { displayUserMessage("Note form elements not found.", true); return; }
            showLoading(true);
            const content = noteContentInput.value.trim();
            if (!content) { displayUserMessage("Note content cannot be empty."); showLoading(false); return; }
            const linkedArtifactIds = Array.from(linkableArtifactsContainer.querySelectorAll('.artifact-link-checkbox:checked')).map(cb => cb.value);
            const newNote = { noteId: generateUUID(), content, timestamp: Timestamp.now(), linkedArtifactIds }; 
            try {
                const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                await updateDoc(ref, { notes: arrayUnion(newNote), updatedAt: serverTimestamp() });
                addNoteForm.reset(); 
                linkableArtifactsContainer.querySelectorAll('.artifact-link-checkbox:checked').forEach(cb => cb.checked = false);
                displayUserMessage("Note added successfully.", false);
            } catch (e) { console.error("Error adding note:", e); displayUserMessage("Failed to add note: " + e.message, true); } 
            finally { showLoading(false); }
        }
        function openEditNoteLinksModal(noteId) { /* ... (Code from previous version) ... */ }
        async function handleSaveNoteLinks() { /* ... (Code from previous version, ensure robust error handling) ... */ }
        function renderNotesList(notes, allDossierArtifacts = []) { /* ... (Code from previous version, ensure robust rendering, escapeHTML, engaging empty state) ... */ }

        // --- Artifacts Section Functions ---
        async function handleAddArtifact(event) {
            event.preventDefault();
            if (!selectedDossierId || !currentUserId) return displayUserMessage("Select dossier first.");
            showLoading(true);
            const name = artifactNameInput.value.trim(); const type = artifactTypeInput.value;
            const source = artifactSourceInput.value.trim(); const category = artifactCategoryInput.value.trim();
            const description = artifactDescriptionInput.value.trim(); const metadataStripped = artifactMetadataStrippedInput.checked;
            if (!name || !type || !source) { displayUserMessage("Name, Type, and Source are required."); showLoading(false); return; }
            const newArtifact = { artifactId: generateUUID(), name, type, source, category: category || '', description, metadataStripped, addedAt: Timestamp.now(), extractedMetadata: null };
            try {
                const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/dossiers`, selectedDossierId);
                await updateDoc(ref, { artifacts: arrayUnion(newArtifact), updatedAt: serverTimestamp() });
                if(addArtifactForm) addArtifactForm.reset(); // Resets all fields including checkbox
                displayUserMessage("Artifact added.", false);
            } catch (e) { displayUserMessage("Failed to add artifact: " + e.message); } finally { showLoading(false); }
        }
        async function handleDeleteArtifact(artifactIdToDelete) { /* ... (Code from previous version, ensure robust error handling) ... */ }
        function renderArtifactsList(artifacts) { /* ... (Code from previous version, ensure robust rendering, escapeHTML, engaging empty state, better metadata display) ... */ }
        
        // --- File Import Function ---
        async function handleProcessImportedFile() { /* ... (Code from previous version, ensure robust error handling and parsing) ... */ }

        // --- Bulk URL Import Function ---
        async function handleAddBulkUrls() { /* ... (Code from previous version, ensure robust error handling, full form reset, and invalid URL skipping message) ... */ }

        // --- Dossier Deletion Function ---
        async function handleDeleteDossier() { /* ... (Code from previous version, ensure robust error handling and clear messaging) ... */ }

        // --- Reporting Function ---
        function handleGenerateReport() { /* ... (Code from previous version, ensure thorough escapeHTML, graceful empty states, and add "Generated On" date to report header) ... */ }

        // --- Event Listeners Setup ---
        function safelyAddEventListener(element, event, handler) {
            if (element) {
                element.addEventListener(event, handler);
            } else {
                console.warn(`Element not found for event listener: ${event} on a missing element. ID: ${element?.id || 'N/A'}`);
            }
        }

        safelyAddEventListener(createDossierForm, 'submit', handleCreateDossier);
        safelyAddEventListener(deleteDossierBtn, 'click', handleDeleteDossier); 
        safelyAddEventListener(generateReportBtn, 'click', handleGenerateReport);
        safelyAddEventListener(addProfileItemForm, 'submit', handleAddProfileItem);
        safelyAddEventListener(profileItemTypeInput, 'change', () => { 
            if(profileItemLabelInput && profileItemTypeInput){
                const showLabel = ['Custom Field', 'Social Media Profile', 'Other'].includes(profileItemTypeInput.value); 
                profileItemLabelInput.classList.toggle('hidden', !showLabel); 
                if (!showLabel) profileItemLabelInput.value = ''; 
            }
        });
        safelyAddEventListener(addSearchLogForm, 'submit', handleAddSearchLog);
        safelyAddEventListener(addEnvDetailForm, 'submit', handleAddEnvDetail);
        safelyAddEventListener(addNoteForm, 'submit', handleAddNote);
        safelyAddEventListener(saveNoteLinksBtn, 'click', handleSaveNoteLinks);
        safelyAddEventListener(cancelEditNoteLinksBtn, 'click', () => { if(editNoteLinksModal) editNoteLinksModal.classList.add('hidden'); currentEditingNoteId = null; });
        safelyAddEventListener(addArtifactForm, 'submit', handleAddArtifact);
        safelyAddEventListener(processImportBtn, 'click', handleProcessImportedFile);
        safelyAddEventListener(addBulkUrlsBtn, 'click', handleAddBulkUrls);
        
        safelyAddEventListener(confirmYesBtn, 'click', () => { 
            if (typeof confirmActionCallback === 'function') { 
                try { confirmActionCallback(); } 
                catch(e) { displayUserMessage("Error executing confirmed action: " + e.message, true); console.error("Error in confirmActionCallback:", e); }
            } 
            if(confirmModal) confirmModal.classList.add('hidden'); 
            confirmActionCallback = null; 
        });
        safelyAddEventListener(confirmNoBtn, 'click', () => { 
            if(confirmModal) confirmModal.classList.add('hidden'); 
            confirmActionCallback = null; 
        });
        
        document.addEventListener('DOMContentLoaded', initializeFirebaseServices);
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; } /* Tailwind slate-200 for body */
        .main-layout-height { height: calc(100vh - 4rem); }
        .sidebar { background-color: #f8fafc; } /* Tailwind slate-50 */
        .main-content-scroll-area { background-color: #f8fafc; } /* Tailwind slate-50 for main panel background */
        .section-card { background-color: #ffffff; } /* White cards for sections within main panel */
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #cbd5e1; } /* Tailwind slate-300 */
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; } /* Tailwind slate-400 */
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* Tailwind slate-500 */
        
        .whitespace-pre-wrap { white-space: pre-wrap; }
        
        .input-field { @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent sm:text-sm; }
        .file-input-field { @apply mt-1 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500; }
        
        .button-base { @apply font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75; }
        .button-primary { @apply button-base bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500; }
        .button-success { @apply button-base bg-green-600 hover:bg-green-700 text-white focus:ring-green-500; }
        .button-purple { @apply button-base bg-purple-600 hover:bg-purple-700 text-white focus:ring-purple-500; }
        .button-teal { @apply button-base bg-teal-600 hover:bg-teal-700 text-white focus:ring-teal-500; }
        .button-danger { @apply button-base bg-red-600 hover:bg-red-700 text-white focus:ring-red-500; }
        .button-secondary { @apply button-base bg-slate-200 hover:bg-slate-300 text-slate-700 focus:ring-slate-400; }
        .button-sky { @apply button-base bg-sky-600 hover:bg-sky-700 text-white focus:ring-sky-500; }
        .button-indigo { @apply button-base bg-indigo-600 hover:bg-indigo-700 text-white focus:ring-indigo-500; }

        .delete-item-btn { @apply text-gray-400 hover:text-red-600 p-0.5 focus:outline-none shrink-0 text-2xl leading-none rounded-full hover:bg-red-100 transition-colors duration-150 opacity-60 hover:opacity-100; }
    </style>
</head>
<body class="bg-slate-200 text-gray-800">
    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-[70] hidden"> <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div> </div>
    <div id="messageDisplayDiv" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl hidden z-[80] transition-all duration-500 ease-in-out max-w-md text-sm font-medium"></div>
    
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] hidden p-4"> <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full"> <h3 class="text-lg font-semibold mb-4 text-gray-800" id="modalTitle">Confirm Action</h3> <p class="mb-6 text-gray-700 text-sm" id="modalMessage">Are you sure?</p> <div class="flex justify-end space-x-3"> <button id="confirmNoBtn" class="button-secondary text-sm">No</button> <button id="confirmYesBtn" class="button-danger text-sm">Yes</button> </div> </div> </div>
    <div id="editNoteLinksModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] hidden p-4"> <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full"> <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Edit Links for Note</h3> <p id="editNoteModalContent" class="text-sm text-gray-700 mb-4 p-3 bg-slate-50 border border-slate-200 rounded max-h-24 overflow-y-auto whitespace-pre-wrap"></p> <div id="editNoteModalArtifactsContainer" class="space-y-1 max-h-48 overflow-y-auto border border-gray-200 p-3 rounded-md bg-white mb-4"><p class="text-xs text-gray-500 italic">Loading artifacts to link...</p></div> <div class="flex justify-end space-x-3 mt-5"> <button id="cancelEditNoteLinksBtn" class="button-secondary text-sm">Cancel</button> <button id="saveNoteLinksBtn" class="button-primary text-sm">Save Link Changes</button> </div> </div> </div>
    
    <header class="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-40 h-16 flex items-center justify-center"> <div> <h1 class="text-2xl md:text-3xl font-bold text-center tracking-tight">Investigation Dossier Manager</h1> <p id="userIdDisplay" class="text-xs text-center text-slate-300 mt-0.5">User ID: Loading...</p> </div> </header>

    <div class="flex flex-col md:flex-row max-w-full mx-auto p-3 md:p-4 gap-4 main-layout-height">
        <div class="w-full md:w-1/3 lg:w-1/4 bg-slate-50 p-4 rounded-xl shadow-lg sidebar flex flex-col">
            <section id="createSection" class="mb-6"> <h2 class="text-xl font-semibold mb-3 text-slate-700 border-b border-slate-300 pb-2">Create New Dossier</h2> <form id="createDossierForm" class="space-y-4"> <div><label for="subjectName" class="block text-sm font-medium text-gray-700">Subject Name*</label><input type="text" id="subjectName" name="subjectName" required class="input-field"></div> <div><label for="caseId" class="block text-sm font-medium text-gray-700">Case ID (optional)</label><input type="text" id="caseId" name="caseId" class="input-field"></div> <div><label for="status" class="block text-sm font-medium text-gray-700">Status</label><select id="status" name="status" class="input-field bg-white"><option>Open</option><option>In Progress</option><option>Pending</option><option>Closed</option></select></div> <div><label for="summary" class="block text-sm font-medium text-gray-700">Summary</label><textarea id="summary" name="summary" rows="3" class="input-field"></textarea></div> <button type="submit" class="button-primary w-full">Create Dossier</button> </form> </section>
            <section id="listSection" class="flex-grow flex flex-col min-h-0"><h2 class="text-xl font-semibold mb-3 text-slate-700 border-b border-slate-300 pb-2">Existing Dossiers</h2><div id="dossiersList" class="mt-2 space-y-2 flex-grow overflow-y-auto pr-1"><p class="text-gray-500 italic p-4 text-center">Loading dossiers...</p></div></section>
        </div>

        <div class="w-full md:w-2/3 lg:w-3/4 bg-slate-50 p-4 rounded-xl shadow-lg main-content-scroll-area flex flex-col">
            <div id="noDossierSelectedMessage" class="text-center text-gray-500 py-10 flex-grow flex flex-col items-center justify-center"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-20 h-20 mx-auto text-gray-400 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg> <p class="text-xl text-gray-600">Select a dossier from the list to view its details, or create a new one.</p> </div>
            <div id="selectedDossier" class="hidden flex-grow flex flex-col min-h-0">
                <section id="dossierDetailsSection" class="mb-6 pb-4 border-b border-slate-300"> <div id="dossierDetails"></div> <div class="mt-4 flex flex-wrap gap-2"> <button id="generateReportBtn" class="button-teal text-sm py-1.5 px-3">Generate Report</button> <button id="deleteDossierBtn" class="button-danger text-sm py-1.5 px-3">Delete This Dossier</button> </div> </section>
                <div class="flex-grow overflow-y-auto space-y-6 pr-2 -mr-2"> 
                    <section id="subjectProfileSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Subject Profile</h3> <form id="addProfileItemForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> <div><label for="profileItemType" class="block text-xs font-medium text-gray-600">Type*</label><select id="profileItemType" class="input-field bg-white text-sm"><option value="Full Name">Full Name</option><option value="Alias">Alias</option><option value="Email">Email</option><option value="Phone">Phone</option><option value="Social Media Profile">Social Media Profile</option><option value="Website">Website</option><option value="Address">Address</option><option value="Custom Field">Custom Field</option><option value="Other">Other</option></select></div> <div><label for="profileItemLabel" class="block text-xs font-medium text-gray-600">Label (if Custom/Other)</label><input type="text" id="profileItemLabel" class="input-field text-sm hidden" placeholder="e.g., Work Phone, Twitter"></div> </div> <div><label for="profileItemValue" class="block text-xs font-medium text-gray-600">Value*</label><input type="text" id="profileItemValue" required class="input-field text-sm" placeholder="Enter profile data"></div> <div><label for="profileItemNotes" class="block text-xs font-medium text-gray-600">Notes</label><textarea id="profileItemNotes" rows="2" class="input-field text-sm" placeholder="Context or source..."></textarea></div> <button type="submit" class="button-primary text-sm py-1.5 px-3">Add Profile Item</button> </form> <div id="subjectProfileList" class="space-y-2 max-h-60 overflow-y-auto pr-1"> <p class="text-sm text-gray-500 italic px-3">No profile items added. Use the form above to add key information.</p> </div> </section>
                    <section id="searchLogSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Investigation Search Log</h3> <form id="addSearchLogForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div><label for="searchQueryText" class="block text-xs font-medium text-gray-600">Search Query*</label><input type="text" id="searchQueryText" required class="input-field text-sm" placeholder="e.g., 'John Doe' site:twitter.com"></div> <div><label for="searchPlatform" class="block text-xs font-medium text-gray-600">Platform/Tool Used*</label><input type="text" id="searchPlatform" required class="input-field text-sm" placeholder="e.g., Google, Twitter, OSINT Tool X"></div> <div><label for="searchLogNotes" class="block text-xs font-medium text-gray-600">Notes</label><textarea id="searchLogNotes" rows="2" class="input-field text-sm" placeholder="Purpose or key findings..."></textarea></div> <button type="submit" class="button-sky text-sm py-1.5 px-3">Log Search Query</button> </form> <div id="searchLogList" class="space-y-2 max-h-60 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No search queries logged. Use the form above to document your process.</p></div> </section>
                    <section id="envDetailsSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Investigation Environment Details</h3> <form id="addEnvDetailForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> <div><label for="envDetailType" class="block text-xs font-medium text-gray-600">Detail Type*</label><select id="envDetailType" class="input-field bg-white text-sm"><option value="Virtual Machine">Virtual Machine</option><option value="Operating System">Operating System</option><option value="Browser Profile">Browser Profile</option><option value="VPN Status">VPN Status</option><option value="IP Address (Current)">IP Address (Current)</option><option value="OSINT Tool & Version">OSINT Tool & Version</option><option value="Custom Detail">Custom Detail</option></select></div> <div><label for="envDetailValue" class="block text-xs font-medium text-gray-600">Value/Specification*</label><input type="text" id="envDetailValue" required class="input-field text-sm" placeholder="e.g., Ubuntu VM, Firefox Profile X"></div> </div> <div><label for="envDetailNotes" class="block text-xs font-medium text-gray-600">Notes</label><textarea id="envDetailNotes" rows="2" class="input-field text-sm" placeholder="Configurations or context..."></textarea></div> <button type="submit" class="button-indigo text-sm py-1.5 px-3">Log Environment Detail</button> </form> <div id="envDetailsList" class="space-y-2 max-h-60 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No environment details logged. Use the form above.</p></div> </section>
                    <section id="notesSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Notes</h3> <form id="addNoteForm" class="mb-4 space-y-3 bg-slate-50 p-3 rounded-md border"> <div><label for="noteContent" class="block text-sm font-medium text-gray-600">Add New Note</label><textarea id="noteContent" name="noteContent" rows="3" required class="input-field" placeholder="Enter your observations, analysis, or next steps..."></textarea></div> <div id="linkableArtifactsContainer" class="space-y-1 max-h-32 overflow-y-auto border border-gray-200 p-2 rounded-md bg-white"><p class="text-xs text-gray-500 italic p-1">Select a dossier with artifacts to link them here.</p></div> <button type="submit" class="button-success">Add Note</button> </form> <div id="notesList" class="space-y-3 max-h-96 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No notes added yet. Use the form above.</p></div> </section>
                    <section id="artifactsSection" class="p-4 bg-white rounded-lg shadow-md border border-slate-200"> 
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Collected Artifacts</h3> 
                        <div class="mb-6 p-3 bg-slate-50 rounded-lg border">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Import List of URLs</h4>
                            <p class="text-xs text-gray-600 mb-3">Paste URLs below (one per line) to add them as URL-type artifacts.</p>
                            <div class="space-y-3">
                                <div><label for="bulkUrlInput" class="block text-xs font-medium text-gray-600">URLs (one per line)*</label><textarea id="bulkUrlInput" rows="3" class="input-field text-sm" placeholder="https://example.com/page1&#10;http://anothersite.org/item"></textarea></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div><label for="bulkUrlCategoryInput" class="block text-xs font-medium text-gray-600">Default Category</label><input type="text" id="bulkUrlCategoryInput" value="Pasted URL" class="input-field text-sm"></div>
                                    <div><label for="bulkUrlDescriptionInput" class="block text-xs font-medium text-gray-600">Default Description</label><textarea id="bulkUrlDescriptionInput" rows="1" class="input-field text-sm" placeholder="Batch imported URLs"></textarea></div>
                                </div>
                                <button id="addBulkUrlsBtn" class="button-teal w-full text-sm py-1.5 px-3">Add URLs as Artifacts</button>
                            </div>
                        </div>
                        <div class="mb-6 p-3 bg-slate-50 rounded-lg border"> 
                            <h4 class="text-md font-semibold text-gray-700 mb-2" title="Supports: JSON array of objects like [{'name':'item1', 'description':'...'}], TXT/CSV (each line becomes an artifact), or single Image files (for EXIF extraction).">Import Artifacts from File <span class="text-gray-400 text-xs">(hover for info)</span></h4>
                            <div class="space-y-3"> 
                                <div><label for="importFileInput" class="block text-xs font-medium text-gray-600">Select File</label><input type="file" id="importFileInput" accept=".json,.txt,.csv,image/*" class="file-input-field"></div> 
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> 
                                    <div><label for="importArtifactTypeInput" class="block text-xs font-medium text-gray-600">Default Type</label><input type="text" id="importArtifactTypeInput" value="Imported Data" class="input-field text-sm"></div> 
                                    <div><label for="importCategoryInput" class="block text-xs font-medium text-gray-600">Default Category</label><input type="text" id="importCategoryInput" value="Imported Batch" class="input-field text-sm"></div> 
                                </div> 
                                <button id="processImportBtn" class="button-teal w-full text-sm py-1.5 px-3">Process Imported File</button> 
                            </div> 
                        </div> 
                        <form id="addArtifactForm" class="space-y-3 bg-slate-50 p-3 rounded-lg border"> 
                             <h4 class="text-md font-semibold text-gray-700">Add New Artifact Manually</h4> 
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"> 
                                 <div><label for="artifactName" class="block text-xs font-medium text-gray-600">Name*</label><input type="text" id="artifactName" required class="input-field text-sm"></div> 
                                 <div><label for="artifactType" class="block text-xs font-medium text-gray-600">Type*</label><select id="artifactType" required class="input-field bg-white text-sm"><option>URL</option><option>Image</option><option>Screenshot</option><option>Video</option><option>Document</option><option>Web Archive Link</option><option>Social Network Post</option><option>Broadcast Stream</option><option>Text Snippet</option><option>Other</option></select></div> 
                             </div> 
                             <div><label for="artifactSource" class="block text-xs font-medium text-gray-600">Source / Link / Filename*</label><input type="text" id="artifactSource" required class="input-field text-sm" placeholder="http://example.com or image.jpg"></div> 
                             <div><label for="artifactCategory" class="block text-xs font-medium text-gray-600">Category</label><input type="text" id="artifactCategory" class="input-field text-sm" placeholder="e.g., Social Media, Evidence"></div> 
                             <div><label for="artifactDescription" class="block text-xs font-medium text-gray-600">Description / Annotation</label><textarea id="artifactDescription" rows="2" class="input-field text-sm" placeholder="Context, collection method..."></textarea></div> 
                             <div class="flex items-center"><input type="checkbox" id="artifactMetadataStripped" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2"><label for="artifactMetadataStripped" class="text-sm text-gray-700">Metadata was stripped</label></div> 
                             <button type="submit" class="button-purple w-full text-sm py-1.5 px-3">Add Artifact</button> 
                        </form> 
                        <div id="artifactsList" class="mt-4 space-y-3 max-h-96 overflow-y-auto pr-1"><p class="text-sm text-gray-500 italic px-3">No artifacts collected. Use the forms above.</p></div> 
                    </section>
                </div>
            </div>
        </div>
    </div>
    <style>
      /* Reusable button/input Tailwind @apply directives (already defined in JS for dynamic parts, useful here for static HTML structure if needed) */
      .button-base { @apply font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75; }
      .button-secondary { @apply button-base bg-slate-200 hover:bg-slate-300 text-slate-700 focus:ring-slate-400; }
      .button-danger { @apply button-base bg-red-600 hover:bg-red-700 text-white focus:ring-red-500; }
    </style>
</body>
</html>
